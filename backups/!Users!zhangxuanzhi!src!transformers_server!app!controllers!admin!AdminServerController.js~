'use strict';

var AdminBaseController = require('./AdminBaseController');
var Server = require('../../models/Server');

function AdminServerController() {
    AdminServerController.super_.call(this);
    var self = this;

    this.action('admin/server/index', function(req, res, cb) {
        app.ServerDAO.find({}, function(err, foundDocs) {
            res.render('server/index.jade',
                       {
                           servers: foundDocs,
                           statusTable: Server.status,
                       }
                      );
            return cb();
        });
    });

    this.action('admin/server/new', function(req, res, cb) {
        res.render('server/new.jade',
                   {
                       server: {},
                       statusTable: Server.status,
                   }
                  );
        return cb();
    });

    this.action('admin/server/update', function(req, res, cb) {
        app.ServerDAO.findOneById(req.param('id'), function(err, foundDoc) {
            res.render('server/update.jade',
                       {
                           server: foundDoc,
                           statusTable: Server.status
                       }
                      );
            return cb();
        });
    });

    this.action('admin/server/doUpdate', function(req, res, cb) {
        app.ServerDAO.findOneById(req.param('id'), function(err, foundDoc) {
            if (err) {
                console.log(err);
            }
            else {
                foundDoc.doc.name = req.param('name');
                foundDoc.doc.url = req.param('url');
                foundDoc.doc.status = parseInt(req.param('status'));
                foundDoc.doc.allowNew = parseInt(req.param('allowNew'));
                app.ServerDAO.update(foundDoc, function(err, updatedDoc) {
                    if (err) {
                        console.log(err);
                    }
                    else {
                        res.redirect('/admin/server/index');
                        return cb();
                    }
                });
            }
        });
    });

    this.action('admin/server/create', function(req, res, cb) {
        var server = {
            _id: parseInt(req.param('id')),
            name: req.param('name'),
            url: req.param('url'),
            status: parseInt(req.param('status')),
            allowNew: parseInt(req.param('allowNew'))
        };
        app.ServerDAO.addOne(server, function(err, insertedDoc) {
            if (err) {
                console.log(err);
            }
            else {
                res.redirect('/admin/server/index');
            }
            return cb();
        });
    });
};

util.inherits(AdminServerController, AdminBaseController);

var ctr = new AdminServerController();

exports.routes = {
    GET: {
        '/admin/server/index': ctr.action('admin/server/index'),
        '/admin/server/new': ctr.action('admin/server/new')
    },
    POST: {
        '/admin/server/update': ctr.action('admin/server/update'),
        '/admin/server/doUpdate': ctr.action('admin/server/doUpdate'),
        '/admin/server/create': ctr.action('admin/server/create')
    }
};
